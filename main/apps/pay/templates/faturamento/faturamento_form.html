{% extends 'main_app/base/base.html' %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Faturamento{% endblock %}

{% block custom_css %}
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.8.1/dist/autoNumeric.min.js"></script>
{% endblock custom_css %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        {% if object %}Editar{% else %}Novo{% endif %} Faturamento
                    </h5>
                    <a href="{% url 'faturamento_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.mes_referencia.id_for_label }}" class="form-label">Mês de Referência *</label>
                            {{ form.mes_referencia }}
                            {% if form.mes_referencia.errors %}
                                <div class="invalid-feedback d-block">{{ form.mes_referencia.errors }}</div>
                            {% endif %}
                            <div class="form-text">Selecione o primeiro dia do mês de referência</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.FaturamentoLoja.id_for_label }}" class="form-label">Pagamento em Loja</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.FaturamentoLoja }}
                            </div>
                            {% if form.FaturamentoLoja.errors %}
                                <div class="invalid-feedback d-block">{{ form.FaturamentoLoja.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.FaturamentoModoBank_PIX.id_for_label }}" class="form-label">ModoBank PIX</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.FaturamentoModoBank_PIX }}
                            </div>
                            {% if form.FaturamentoModoBank_PIX.errors %}
                                <div class="invalid-feedback d-block">{{ form.FaturamentoModoBank_PIX.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.FaturamentoModoBank_Cartao.id_for_label }}" class="form-label">ModoBank Cartão</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.FaturamentoModoBank_Cartao }}
                            </div>
                            {% if form.FaturamentoModoBank_Cartao.errors %}
                                <div class="invalid-feedback d-block">{{ form.FaturamentoModoBank_Cartao.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.FaturamentoEfiBank_Boleto.id_for_label }}" class="form-label">EfiBank Boleto</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.FaturamentoEfiBank_Boleto }}
                            </div>
                            {% if form.FaturamentoEfiBank_Boleto.errors %}
                                <div class="invalid-feedback d-block">{{ form.FaturamentoEfiBank_Boleto.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.FaturamentoCelcoin_Cartao.id_for_label }}" class="form-label">Celcoin Cartão</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.FaturamentoCelcoin_Cartao }}
                            </div>
                            {% if form.FaturamentoCelcoin_Cartao.errors %}
                                <div class="invalid-feedback d-block">{{ form.FaturamentoCelcoin_Cartao.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.FaturamentoMaquinaCartao.id_for_label }}" class="form-label">Maquina Cartão</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.FaturamentoMaquinaCartao }}
                            </div>
                            {% if form.FaturamentoMaquinaCartao.errors %}
                                <div class="invalid-feedback d-block">{{ form.FaturamentoMaquinaCartao.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.valor.id_for_label }}" class="form-label">Faturamento Bruto Total*</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.valor }}
                            </div>
                            {% if form.valor.errors %}
                                <div class="invalid-feedback d-block">{{ form.valor.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.observacao.id_for_label }}" class="form-label">Observação</label>
                            {{ form.observacao }}
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i> Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% block extra_js %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lista de IDs que terão máscara
    const campos = [
        'id_FaturamentoLoja',
        'id_FaturamentoModoBank_PIX',
        'id_FaturamentoModoBank_Cartao',
        'id_FaturamentoEfiBank_Boleto',
        'id_FaturamentoCelcoin_Cartao',
        'id_FaturamentoMaquinaCartao'
    ];

    // Armazena instâncias do AutoNumeric
    const autoNumericInstances = [];
    let form = null;

    // Inicializa AutoNumeric em cada campo
    campos.forEach(function(campoId) {
        const input = document.getElementById(campoId);
        if (input) {
            // Pega o formulário a partir do primeiro input
            if (!form) {
                form = input.closest('form');
            }
            
            // Limpa o valor inicial se vier vazio
            if (!input.value || input.value.trim() === '') {
                input.value = '0';
            }
            
            const an = new AutoNumeric(input, {
                currencySymbol: '',
                decimalCharacter: ',',
                digitGroupSeparator: '.',
                decimalPlaces: 2,
                minimumValue: '0',
                modifyValueOnWheel: false
            });
            
            autoNumericInstances.push({ id: campoId, element: input, anInstance: an });
        }
    });

    // Função para calcular total
    function calcularTotal() {
        let total = 0;
        autoNumericInstances.forEach(function(item) {
            const valor = parseFloat(item.anInstance.getNumber()) || 0;
            total += valor;
        });
        
        const campoTotal = document.querySelector('input[name="valor"]');
        if (campoTotal) {
            campoTotal.value = total.toFixed(2).replace('.', ',');
        }
    }

    // Adiciona eventos de cálculo
    autoNumericInstances.forEach(function(item) {
        item.element.addEventListener('input', calcularTotal);
        item.element.addEventListener('blur', calcularTotal);
    });

    // Torna o campo total readonly
    const campoTotal = document.querySelector('input[name="valor"]');
    if (campoTotal) {
        campoTotal.setAttribute('readonly', 'readonly');
        campoTotal.style.backgroundColor = '#e9ecef';
    }

    // Calcula total inicial
    calcularTotal();

    // Converte valores antes de enviar
    if (form) {
        form.addEventListener('submit', function() {
            // Converte cada campo formatado para número puro
            autoNumericInstances.forEach(function(item) {
                const numeroLimpo = item.anInstance.getNumber();
                item.element.value = numeroLimpo;
            });
            
            // Converte também o campo total
            if (campoTotal) {
                const valorTotal = campoTotal.value.replace(/\./g, '').replace(',', '.');
                campoTotal.value = valorTotal;
            }
        });
    }

    // Validação do Bootstrap
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()
});
</script>
{% endblock extra_js %}
{% endblock %}